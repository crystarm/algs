name: build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm-slim

    env:
      CLANG_VER: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install base deps
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates git findutils sed coreutils \
            build-essential \
            wget gnupg lsb-release

      - name: Install LLVM/Clang (optionally pinned)
        run: |
          set -euo pipefail

          if [ -n "${CLANG_VER}" ]; then
            # apt.llvm.org for specific clang version
            wget -qO /tmp/llvm.sh https://apt.llvm.org/llvm.sh
            chmod +x /tmp/llvm.sh

            # llvm.sh sometimes needs a second pass with fresh apt cache on some setups,
            # so we do a simple fallback.
            /tmp/llvm.sh "${CLANG_VER}" || (apt-get update && /tmp/llvm.sh "${CLANG_VER}")

            export CC="clang-${CLANG_VER}"
            export CXX="clang++-${CLANG_VER}"
          else
            apt-get update
            apt-get install -y --no-install-recommends clang
            export CC="clang"
            export CXX="clang++"
          fi

          echo "CC=$CC"
          echo "CXX=$CXX"
          $CC --version
          $CXX --version

          echo "CC=$CC" >> $GITHUB_ENV
          echo "CXX=$CXX" >> $GITHUB_ENV

      - name: Install PyPy, PHP, Mono (C#)
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            pypy3 \
            php-cli \
            mono-devel

          pypy3 --version
          php -v
          mcs --version
          mono --version

      - name: C/C++ compile check (Clang only)
        run: |
          set -euo pipefail
          mkdir -p build_ci

          # C++
          while IFS= read -r -d '' f; do
            out="build_ci/$(echo "$f" | sed 's|^\./||; s|/|__|g; s|\.cpp$||')"
            echo "C++: $f -> $out"
            "$CXX" -std=c++20 -O2 -pipe "$f" -o "$out"
          done < <(find . -type f -name '*.cpp' -print0)

          # C
          while IFS= read -r -d '' f; do
            out="build_ci/$(echo "$f" | sed 's|^\./||; s|/|__|g; s|\.c$||')"
            echo "C: $f -> $out"
            "$CC" -std=c11 -O2 -pipe "$f" -o "$out"
          done < <(find . -type f -name '*.c' -print0)

      - name: C# compile check (Mono)
        run: |
          set -euo pipefail
          mkdir -p build_ci_cs

          while IFS= read -r -d '' f; do
            out="build_ci_cs/$(echo "$f" | sed 's|^\./||; s|/|__|g; s|\.cs$||').exe"
            echo "C#: $f -> $out"
            mcs -optimize+ -out:"$out" "$f"
          done < <(find . -type f -name '*.cs' -print0)

      - name: Python syntax check (PyPy compileall)
        run: |
          set -euo pipefail
          pypy3 -m compileall -q .

      - name: PHP lint (Zend php-cli)
        run: |
          set -euo pipefail
          while IFS= read -r -d '' f; do
            echo "PHP: lint $f"
            php -l "$f" > /dev/null
          done < <(find . -type f -name '*.php' -print0)
